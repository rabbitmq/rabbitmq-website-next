<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta content="73d8ba46-8c12-43f6-8c22-24aa21b8d93d" name="onetrust-data-domain" /><meta content="https://tags.tiqcdn.com/utag/vmware/microsites-privacy/prod/utag.js" name="microsites-utag" /><script src="https://d1fto35gcfffzn.cloudfront.net/assets/jquery-1.11.2.min.js"></script><script src="//www.vmware.com/files/templates/inc/utag_data.js"></script><script src="//tags.tiqcdn.com/utag/vmware/microsites-privacy/prod/utag.sync.js"></script><script>function OptanonWrapper() { { window.dataLayer.push({ event: 'OneTrustGroupsUpdated' }); } }</script><script src="/js/gtm.js"></script><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="googlebot" content="NOODP" /><meta name="google-site-verification" content="nSYeDgyKM9mw5CWcZuD0xu7iSWXlJijAlg9rcxVOYf4" /><meta name="google-site-verification" content="6UEaC3SWhpGQvqRnSJIEm2swxXpM5Adn4dxZhFsNdw0" /><meta content="width=device-width, initial-scale=1.0, maximum-scale=1, minimum-scale=1, user-scalable=no" id="viewport" name="viewport" /><link href="https://fonts.googleapis.com/css?family=Raleway:400,500,600,700" rel="stylesheet" /><link rel="stylesheet" href="/css/rabbit.css" type="text/css" /><link rel="stylesheet" href="/css/highlightjs_style.css" type="text/css" /><link rel="stylesheet" href="/css/rabbit-next.css" type="text/css" /><!--[if IE 6]>
      <link rel="stylesheet" href="/css/rabbit-ie6.css" type="text/css" />
      <![endif]--><link rel="icon" type="/image/vnd.microsoft.icon" href="/favicon.ico" /><link rel="stylesheet" href="/css/tutorial.css" type="text/css" /><script async="true" type="text/javascript" src="/js/site.js"></script><title> Using RabbitMQ Cluster Kubernetes Operator
 — RabbitMQ</title></head>
  <body id="kubernetes/operator/using-operator"><div id="outerContainer"><div class="container"><div class="rabbit-logo"><a href="/"><img src="/img/logo-rabbitmq.svg" alt="RabbitMQ" /></a></div><a class="btn menubtn" onclick="showHide()">Menu <img src="/img/carrot-down-white.svg" /></a><div class="mobilemenuicon" onclick="showHide()"><img src="/img/mobile-menu-icon.svg" /></div><div id="nav"><ul id="mainNav"><li><a href="/#features">Features</a></li><li><a href="/#getstarted">Get Started</a></li><li><a href="/#support">Support</a></li><li><a href="/#community">Community</a></li><li><a href="/documentation.html">Docs</a></li></ul></div></div><div class="nav-separator"></div><div id="innerContainer" class="container"><div id="left-content"><h1> Using RabbitMQ Cluster Kubernetes Operator
</h1>
<h2><a id="overview" class="anchor" href="#overview">Overview</a></h2>
<p>This guide covers how to deploy Custom Resource objects that will
be managed by the <a href="./operator-overview.html">RabbitMQ Cluster Kubernetes Operator</a>.
If RabbitMQ Cluster Kubernetes Operator is not installed,
see the <a href="./install-operator.html">installation guide</a>. For instructions on getting started quickly, see the <a href="./quickstart-operator.html">quickstart guide</a>.
This guide is structured in the following sections:</p>
<ul>
<li><a href="#service-availability">Confirm Service Availability</a></li>
<li><a href="#psp">Apply Pod Security Policies</a></li>
<li><a href="#create">Create a RabbitMQ Instance</a></li>
<li><a href="#examples">Existing examples</a></li>
<li><a href="#configure">Configure a RabbitMQ Instance</a></li>
<li><a href="#update">Update a RabbitMQ Instance</a></li>
<li><a href="#set-pdb">Set a Pod Disruption Budget</a></li>
<li><a href="#tls">Configure TLS</a></li>
<li><a href="#find">Find Your RabbitmqCluster Service Name and Admin Credentials</a></li>
<li><a href="#vault">Use HashiCorp Vault</a></li>
<li><a href="#verify-instance">Verify the Instance is Running</a></li>
<li><a href="#use">Use the RabbitMQ Service in Your App</a></li>
<li><a href="#monitoring">Monitor RabbitMQ Clusters</a></li>
<li><a href="#network-policies">Restrict traffic using Network Policies</a></li>
<li><a href="#delete">Delete a RabbitMQ Instance</a></li>
<li><a href="#pause">Pause Reconciliation for a RabbitMQ Instance</a></li>
<li><a href="#operator-log">Configure Log Level for the Operator</a></li>
</ul>
<p>Additional information about using the operator on Openshift can be found at
<a href="using-on-openshift.html">Using the RabbitMQ Kubernetes Operators on Openshift</a>.</p>
<h2><a id="service-availability" class="anchor" href="#service-availability">Confirm Service Availability</a></h2>
<p>Before configuring your app to use RabbitMQ Cluster Kubernetes Operator, ensure that RabbitmqCluster Custom Resource is deployed
to your Kubernetes cluster and is available.</p>
<p>To confirm this availability, run</p>
<pre class="lang-bash">
kubectl get customresourcedefinitions.apiextensions.k8s.io
</pre>

<p>Then verify that <span class="code ">rabbitmqclusters.rabbitmq.com</span> is on the list, as in the example below:</p>
<pre class="lang-bash">
kubectl get customresourcedefinitions.apiextensions.k8s.io
# NAME                                   CREATED AT
# rabbitmqclusters.rabbitmq.com   2019-10-23T10:11:06Z
</pre>

<p>If it is not, install it by following the steps in the <a href="./install-operator.html">installation guide</a>.</p>
<h2><a id="psp" class="anchor" href="#psp">(Optional) Apply Pod Security Policies</a></h2>
<p>If <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/">pod security policies</a> are enabled in the Kubernetes cluster,
a <span class="code ">[Cluster]Role</span> and <span class="code ">[Cluster]RoleBinding</span> must be created to enable the Pods to be scheduled. For more information about Pod security policies,
see the <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/">Kubernetes documentation</a>.
If <span class="code ">Role</span> and <span class="code ">RoleBinding</span> are used, it will only be effective in the Namespace where the RBACs are deployed.</p>
<p>If Pod security policies are not enabled, skip to <a href="#create">Create a RabbitMQ Instance</a> below.</p>
<p>The <span class="code ">Role</span> and <span class="code ">RoleBinding</span> should be created before a <span class="code ">RabbitmqCluster</span> instance is created. It's ok to create a binding that refers to a non-existing
Service Account or User. The Operator creates a Service Account using the pattern <span class="code ">INSTANCE-NAME-server</span>. For example, a <span class="code ">RabbitmqCluster</span> named
'mycluster' will generate a Service Account named <span class="code ">mycluster-server</span>. In order to allow a Service Account to use PSPs, a Role with the verb 'use' must
be bound to the Service Account. For example:</p>
<pre class="lang-bash">
# Assuming RabbitmqCluster name is 'mycluster'

kubectl create role rabbitmq:psp:unprivileged \
    --verb=use \
    --resource=podsecuritypolicy \
    --resource-name=some-pod-security-policy
# role "rabbitmq:psp:unprivileged" created

kubectl create rolebinding rabbitmq-mycluster:psp:unprivileged \
    --role=rabbitmq:psp:unprivileged \
    --serviceaccount=some-namespace:mycluster-server
# rolebinding "rabbitmq-mycluster:psp:unprivileged" created
</pre>

<p><a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/#example">Kubernetes documentation</a> has an example
to create RBAC rules and a policy.</p>
<h2><a id="create" class="anchor" href="#create">Create a RabbitMQ Instance</a></h2>
<p>To create a RabbitMQ instance, a <span class="code ">RabbitmqCluster</span> resource definition must be created and applied.
RabbitMQ Cluster Kubernetes Operator creates the necessary resources, such as Services and StatefulSet, in the same namespace
in which the <span class="code ">RabbitmqCluster</span> was defined.</p>
<p>First, create a YAML file to define a <span class="code ">RabbitmqCluster</span> resource named <span class="code ">definition.yaml</span>.</p>
<p class="note">
  <strong>Note:</strong> The YAML file can have any name, but the steps that follow assume it is named
  <span class="code ">definition</span>.
</p>

<p>Then copy and paste the below snippet into the file and save it:</p>
<pre class="lang-yaml">
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: definition
</pre>

<p class="note">
<strong>Note:</strong> when creating RabbitmqClusters on Openshift, there are extra parameters that must be added to
all RabbitmqCluster manifests. See <a href="./using-on-openshift.html#arbitrary-user-ids">Support for Arbitrary User IDs</a> for details.
</p>

<p>Next, apply the definition by running:</p>
<pre class="lang-bash">
kubectl apply -f definition.yaml
</pre>

<p>Then verify that the process was successful by running:</p>
<pre class="lang-bash">
kubectl get all -l app.kubernetes.io/name=definition
</pre>

<p>If successful, there will be a running pod and a service that exposes the instance.
For example:</p>
<pre class="lang-bash">
kubectl get all -l app.kubernetes.io/name=definition
# NAME                      READY   STATUS    RESTARTS   AGE
# pod/definition-server-0   1/1     Running   0          112s
#
# NAME                          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                        AGE
# service/definition-nodes      ClusterIP   None             None        4369/TCP                       113s
# service/definition            ClusterIP   10.103.214.196   None        5672/TCP,15672/TCP,15692/TCP   113s
</pre>

<p>A RabbitMQ cluster is now ready to be used by applications. Continue for more advanced configuration options.
For more information, see the <a href="../../documentation.html">RabbitMQ documentation guides</a>.</p>
<h3><a id="internal-labels" class="anchor" href="#internal-labels"> Internal labels and annotations</a></h3>
<p>The child resources created by the Cluster Operator always have the following set of labels:</p>
<ul>
<li><span class="code ">app.kubernetes.io/name</span> - the value is the <span class="code ">RabbitmqCluster</span> name associated to the resource.</li>
<li><span class="code ">app.kubernetes.io/component</span> - the component it belongs to. Currently always set to <span class="code ">rabbitmq</span>.</li>
<li><span class="code ">app.kubernetes.io/part-of</span> - The name of a higher level application this one is part of. Currently always set to <span class="code ">rabbitmq</span>.</li>
</ul>
<p>The same set of labels is applied to the Pods created by the StatefulSet. In addition to the above, the following
two annotations are added to the Pods:</p>
<ul>
<li><span class="code ">prometheus.io/port</span> - with value <span class="code ">15692</span>.</li>
<li><span class="code ">prometheus.io/scrape</span> - with value <span class="code ">true</span>.</li>
</ul>
<h2><a id="examples" class="anchor" href="#examples">Existing examples</a></h2>
<p>There are examples for some common use cases in the <a href="https://github.com/rabbitmq/cluster-operator/tree/main/docs/examples">GitHub repository</a>.
Some interesting use cases are:</p>
<ul>
<li><a href="https://github.com/rabbitmq/cluster-operator/tree/main/docs/examples/import-definitions">How to import a definitions file</a> in RabbitMQ using the Operator</li>
<li><a href="https://github.com/rabbitmq/cluster-operator/tree/main/docs/examples/resource-limits">How to configure memory and CPU limits for RabbitMQ</a></li>
<li><a href="https://github.com/rabbitmq/cluster-operator/tree/main/docs/examples/production-ready">A production ready example</a>, tested in Google Cloud Platform and
a good baseline to start.</li>
</ul>
<p>There are more <a href="https://github.com/rabbitmq/cluster-operator/tree/main/docs/examples">examples available</a>.</p>
<h2><a id="configure" class="anchor" href="#configure">Configure a RabbitMQ Instance</a></h2>
<p>To configure a RabbitMQ instance, open <span class="code ">definition.yaml</span> or edit the configuration in place by running:</p>
<pre class="lang-bash">
kubectl edit rabbitmqcluster definition
</pre>

<p>Next, add any of the properties described below along with their values. Every property listed below is optional.</p>
<p>A number of <a href="https://github.com/rabbitmq/cluster-operator/tree/main/docs/examples">configuration examples</a> are available
in the Operator repository on GitHub.</p>
<h3><a name="labels-annotations" class="anchor" href="#labels-annotations" id="labels-annotations">Labels and Annotations</a></h3>
<p><strong>Description:</strong> Labels and annotations in RabbitmqCluster metadata are propagated to the resources created by
the Operator. The Pods <strong>do not</strong> inherit these labels and/or annotations.</p>
<p><strong>Default Value:</strong> N/A - Empty</p>
<p><strong>Example:</strong></p>
<pre class="lang-yaml">
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  labels:
    app: rabbitmq
  annotations:
    some: annotation
  name: rabbitmqcluster-sample
</pre>

<h3><a name="replicas" class="anchor" href="#replicas" id="replicas">Number of Replicas</a></h3>
<p><strong>Description:</strong> Specify the number of replicas for the RabbitmqCluster. <a href="../../clustering.html#node-count">An even number of replicas
is highly discouraged</a>. Odd numbers (1, 3, 5, 7, and so on)
<a href="../../clustering.html#node-count">must be used</a>.</p>
<p><strong>Default Value:</strong> 1</p>
<p><strong>Example:</strong></p>
<pre class="lang-yaml">
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rabbitmqcluster-sample
spec:
  replicas: 3
</pre>

<h3><a name="images" class="anchor" href="#images" id="images">Image</a></h3>
<p><strong>Description:</strong> Specify the RabbitMQ image reference.
This property is necessary if a private registry is used.</p>
<p><strong>Default Value:</strong> The community <a href="https://hub.docker.com/_/rabbitmq">RabbitMQ with management plugin image</a>.</p>
<p><strong>Example:</strong></p>
<pre class="lang-yaml">
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rabbitmqcluster-sample
spec:
  image: my-private-registry/rabbitmq:my-custom-tag
</pre>

<h3><a name="image-pull-secrets" class="anchor" href="#image-pull-secrets" id="image-pull-secrets">imagePullSecrets</a></h3>
<p><strong>Description:</strong> An array of <span class="code ">Secret</span> names to be used as <span class="code ">imagePullSecrets</span> for the RabbitMQ image.
If the registry requires authentication, this array must have the name of the secret used to pull images.
Kubernetes Secrets can be created by running:</p>
<pre class="lang-bash">
kubectl -n rabbitmq-system create secret docker-registry
</pre>

<p><strong>Default Value:</strong> N/A</p>
<p><strong>Example:</strong></p>
<pre class="lang-yaml">
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rabbitmqcluster-sample
spec:
  image: my-private-registry/rabbitmq:3.10
  imagePullSecrets:
  - name: some-secret
</pre>

<h3><a name="service-type" class="anchor" href="#service-type" id="service-type">Service Type</a></h3>
<p><strong>Description:</strong> Specify the Kubernetes Service type for the RabbitmqCluster Service.
The available types are:</p>
<ul>
<li>ClusterIP</li>
<li>NodePort</li>
<li>LoadBalancer</li>
</ul>
<p>RabbitMQ Cluster Kubernetes Operator currently does not support the ExternalName Service Type.</p>
<p><strong>Default Value:</strong> ClusterIP</p>
<p><strong>Example:</strong></p>
<pre class="lang-yaml">
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rabbitmqcluster-sample
spec:
  service:
    type: LoadBalancer
</pre>

<h3><a name="service-annotations" class="anchor" href="#service-annotations" id="service-annotations">Service Annotations</a></h3>
<p><strong>Description:</strong> Specify the Kubernetes Service annotations for the RabbitmqCluster Service. The Services created
by the RabbitMQ Cluster Kubernetes Operator will have these annotations.</p>
<p><strong>Default Value:</strong> N/A</p>
<p><strong>Example:</strong></p>
<pre class="lang-yaml">
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rabbitmqcluster-sample
spec:
  service:
    annotations:
      service.beta.kubernetes.io/aws-load-balancer-internal: 0.0.0.0/0
</pre>

<h3><a name="persistence" class="anchor" href="#persistence" id="persistence">Persistence</a></h3>
<p><strong>Description:</strong> Specify the persistence settings for the RabbitmqCluster Service.
The available settings are:</p>
<ul>
<li><span class="code ">storageClassName</span>: The name of the Kubernetes StorageClass to use.
    <p class="note">
      <strong>Note:</strong> If your cluster does not have a default StorageClass, this property
      must be set, otherwise RabbitMQ Pods will not be scheduled because they require a Persistent Volume.
    </p></li>
<li><span class="code ">storage</span>: The capacity of the persistent volume, expressed as a Kubernetes resource quantity. Set to <span class="code ">0</span> to deactivate persistence altogether (this may be convenient in CI/CD and test deloyments that should always start fresh).</li>
</ul>
<p><strong>Default Values:</strong></p>
<ul>
<li><span class="code ">storageClassName</span>: Not set by default. If you do not set a value, the default <span class="code ">StorageClass</span> for the Kubernetes cluster is used.</li>
<li><span class="code ">storage</span>: 10Gi</li>
</ul>
<p>To see the default <span class="code ">StorageClass</span>, run <span class="code ">kubectl get storageclasses</span>.</p>
<p><strong>Example:</strong></p>
<pre class="lang-yaml">
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rabbitmqcluster-sample
spec:
   persistence:
    storageClassName: fast
    storage: 20Gi
</pre>

<p>For more information about concepts mentioned above, see:</p>
<table class="nice">
<col width="50%" />
<col width="50%">
    <th>Concept</th>
    <th>More information in…</th>
    <tr>
        <td>StorageClass</td>
        <td>The <a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#the-storageclass-resource">Kubernetes documentation</a></td>
    </tr>
    <tr>
        <td>Persistent volume capacity</td>
        <td>The <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#capacity">Kubernetes documentation</a></td>
    </tr>
    <tr>
        <td>Kubernetes Resource Quantity</td>
        <td>The <a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/">Kubernetes Resource Model documentation</a> in GitHub</td>
    </tr>
    </col>
 </table>

<p class="note">
   <strong>Note:</strong> using <a href="https://github.com/rancher/local-path-provisioner" target="_blank">local-path provisioner</a> does not enforce a disk size.
   This means that RabbitMQ will report more disk available than the configured in <span class="code ">.spec.peristence.storage</span>. This happens because the
   Persistent Disk is created as a local folder in the Kubernetes node hosting the Pod.
 </p>

<h3><a name="resource-reqs" class="anchor" href="#resource-reqs" id="resource-reqs">Resource Requirements</a></h3>
<p><strong>Description:</strong> Specify the resource requests and limits of the <span class="code ">RabbitmqCluster</span> Pods.
CPU requirements must be in CPU units. Memory requirements must be in bytes.
Both values must be expressed as a Kubernetes resource quantity.</p>
<p>The <span class="code ">RabbitMQCluster</span> does not deploy if these configurations are provided but not valid.</p>
<p><strong>Default Values:</strong></p>
<ul>
<li>Memory limit: 2 Gi</li>
<li>CPU limit: 2000 millicores</li>
<li>Memory request: 2 Gi</li>
<li>CPU request: 1000 millicores</li>
</ul>
<p>The RabbitMQ high-water mark is set to 0.4 times the memory limit.
It is recommended to keep the memory requests and limits as the same value.</p>
<p><strong>Example:</strong></p>
<pre class="lang-yaml">
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rabbitmqcluster-sample
spec:
  resources:
    requests:
      cpu: 1000m
      memory: 2Gi
    limits:
      cpu: 1000m
      memory: 2Gi
</pre>

<p><strong>Note:</strong> It's possible for RabbitMQ and Erlang to temporarily exceed the total available memory, which could cause an immediate OOM kill.
To prevent this from happening, the cluster operator sets memory headroom of 20% (with a max value of 2GB) by configuring <span class="code ">total_memory_available_override_value</span>.
This means the actual memory limit set in RabbitMQ is 20% less than the specified resource requirement.</p>
<p>For more information about concepts mentioned above, see:</p>
<table class="nice">
  <col width="50%" />
  <col width="50%">
    <th>Concept</th>
    <th>More information in…</th>
    <tr>
        <td>Resource request and limit requirements</td>
        <td>The <a href="https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/">Kubernetes documentation</a></td>
    </tr>
    <tr>
        <td>CPU measurement</td>
        <td>The <a href="https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/#meaning-of-cpu">Kubernetes documentation</a></td>
    </tr>
    <tr>
        <td>High-water mark</td>
        <td>The <a href="../../memory.html#threshold">RabbitMQ documentation</a></td>
    </tr>
  </col>
</table>

<h3><a name="affinity" class="anchor" href="#affinity" id="affinity">Affinity and Anti-affinity Rules</a></h3>
<p><strong>Description:</strong> Affinity and anti-affinity rules are structured in the same way as <a href="https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity">Kubernetes affinity rules</a>.</p>
<p><strong>Default Value:</strong> N/A</p>
<p><strong>Example:</strong></p>
<pre class="lang-yaml">
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rabbitmqcluster-sample
spec:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.io/hostname
            operator: In
            values:
            - node-1
</pre>

<h3><a name="tolerations" class="anchor" href="#tolerations" id="tolerations">Pod Tolerations</a></h3>
<p><strong>Description:</strong> Add <a href="https://kubernetes.io/docs/concepts/configuration/taint-and-toleration">tolerations</a> for the RabbitmqCluster pods.</p>
<p><strong>Default Value:</strong> N/A</p>
<p><strong>Example:</strong></p>
<pre class="lang-yaml">
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rabbitmqcluster-sample
spec:
  tolerations:
    - key: "dedicated"
      operator: "Equal"
      value: "rabbitmq"
      effect: "NoSchedule"
</pre>

<h3><a name="additional-config" class="anchor" href="#additional-config" id="additional-config">RabbitMQ Additional Configuration</a></h3>
<p><strong>Description:</strong> Additional RabbitMQ configuration options that will be written to <span class="code ">/etc/rabbitmq/conf.d/90-userDefinedConfiguration.conf</span>. The RabbitMQ Cluster Kubernetes Operator
generates a configuration file <span class="code ">/etc/rabbitmq/conf.d/10-operatorDefaults.conf</span> with the following properties:</p>
<pre class="lang-ini">
cluster_formation.peer_discovery_backend             = rabbit_peer_discovery_k8s
cluster_formation.k8s.host                           = kubernetes.default
cluster_formation.k8s.address_type                   = hostname
cluster_partition_handling                           = pause_minority
queue_leader_locator                                 = balanced
disk_free_limit.absolute                             = 2GB
cluster_formation.randomized_startup_delay_range.min = 0
cluster_formation.randomized_startup_delay_range.max = 60
</pre>

<p>All the values in additional config will be applied after this list. If any property is specified twice, the latest
will take effect. To learn more about RabbitMQ configuration options and formart, check out the dedicated <a href="../../configure.html">Configuration Documentation</a>.</p>
<p><strong>Default Value:</strong> N/A</p>
<p><strong>Example:</strong></p>
<pre class="lang-yaml">
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rabbitmqcluster-sample
spec:
  rabbitmq:
    additionalConfig: |
      channel_max = 1050
</pre>

<h3><a name="advanced-config" class="anchor" href="#advanced-config" id="advanced-config">RabbitMQ Advanced Configuration</a></h3>
<p><strong>Description:</strong> Advanced configuration that will be written to <span class="code ">/etc/rabbitmq/advanced.config</span> file.</p>
<p><strong>Default Value:</strong> N/A</p>
<p><strong>Example:</strong></p>
<pre class="lang-yaml">
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rabbitmqcluster-sample
spec:
  rabbitmq:
    advancedConfig: |
      [
          {ra, [
              {wal_data_dir, '/var/lib/rabbitmq/quorum-wal'}
          ]}
      ].
</pre>

<h3><a name="env-config" class="anchor" href="#env-config" id="env-config">RabbitMQ Environment Configuration</a></h3>
<p><strong>Description:</strong> RabbitMQ uses <span class="code ">rabbitmq-env.conf</span> to override the defaults built-in into the RabbitMQ scripts and CLI tools.
The value of <span class="code ">spec.rabbitmq.envConfig</span> will be written to <span class="code ">/etc/rabbitmq/rabbitmq-env.conf</span>.</p>
<p><strong>Default Value:</strong> N/A</p>
<p><strong>Example:</strong></p>
<pre class="lang-yaml">
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rabbitmqcluster-sample
spec:
  rabbitmq:
    envConfig: |
      RABBITMQ_DISTRIBUTION_BUFFER_SIZE=some_value
</pre>

<p>Please refer to <a href="#override">the <span class="code ">spec.override</span> property</a> for additional ways of customizing the environment.</p>
<h3><a name="additional-plugins" class="anchor" href="#additional-plugins" id="additional-plugins">RabbitMQ Additional Plugins</a></h3>
<p><strong>Description:</strong> Additional plugins to enable in RabbitMQ. RabbitMQ Cluster Kubernetes Operator enabled <span class="code ">rabbitmq_peer_discovery_k8s</span>,
<span class="code ">rabbitmq_prometheus</span> and <span class="code ">rabbitmq_management</span> by default. Plugins on this list will also be enabled.</p>
<p><strong>Default Value:</strong> N/A</p>
<p><strong>Example:</strong></p>
<pre class="lang-yaml">
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rabbitmqcluster-sample
spec:
  rabbitmq:
    additionalPlugins:
      - rabbitmq_top
      - rabbitmq_shovel
</pre>

<p>If community plugins need to be provisioned, they should be included into a custom image or <a href="https://github.com/rabbitmq/cluster-operator/tree/main/docs/examples/community-plugins">downloaded on node startup</a>. The latter option is generally
<strong>not recommended</strong> as it goes against the philosophy of immutable images and repeatable builds.</p>
<h3><a name="tls-conf" class="anchor" href="#tls-conf" id="tls-conf">TLS Configuration</a></h3>
<p><strong>Description:</strong> Configure RabbitMQ to use the certificates provided by Secret <span class="code ">spec.tls.secretName</span>. The Secret must
already exist in the same Namespace as the <span class="code ">RabbitmqCluster</span> object. It is expected that the Secret contains <span class="code ">tls.key</span>
and <span class="code ">tls.crt</span> for the private key and public certificate respectively.</p>
<p>By default, enabling <a href="../../ssl.html">TLS for client connections</a> does not disable non-TLS listeners. Therefore, unencrypted connections will still be accepted.
To disable non-TLS listeners and only accept TLS connections, set <span class="code ">spec.tls.disableNonTLSListeners: true</span>.</p>
<p>It is also possible to make RabbitMQ <a href="../../ssl.html#peer-verification">verify peer certificates</a> against a provided CA certificate.
The same can be done by clients, so peer verification can be mutual ("mTLS").
This certificate must be stored in a Secret of name <span class="code ">spec.tls.caSecretName</span>, in the same Namespace as the <span class="code ">RabbitmqCluster</span>
object. Note that this can be the same Secret as <span class="code ">spec.tls.secretName</span>. This Secret <strong>must</strong> have a key <span class="code ">ca.crt</span> containing
the CA certificate.</p>
<p>RabbitMQ nodes can reload TLS certificates without a node restart. To rotate the TLS certificate, update the TLS Secret object
with the new certificate directly and this change will be picked up by the RabbitMQ pods within several minutes.
If you need to speed up the process, you can force RabbitMQ to reload the certificate immediately by running:</p>
<pre class="lang-bash">
kubectl exec -it INSTANCE-server-0 -- rabbitmqctl eval "ssl:clear_pem_cache()."
</pre>

<p>or directly from within the node pod:</p>
<pre class="lang-bash">
rabbitmqctl eval "ssl:clear_pem_cache()."
</pre>

<p>Since each node has its own cache, if you decide to run this command, you should execute it on all cluster nodes.</p>
<p><strong>Default Value:</strong> N/A</p>
<p><strong>Example:</strong></p>
<pre class="lang-yaml">
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rabbitmqcluster-sample
spec:
  tls:
    secretName: rabbitmq-server-certs
    caSecretName: rabbitmq-ca-cert
    disableNonTLSListeners: true
</pre>

<h3><a name="SkipPostDeploySteps" class="anchor" href="#SkipPostDeploySteps" id="SkipPostDeploySteps">Skip Post Deploy</a></h3>
<p><strong>Description:</strong> If unset, or set to false, operator will run <span class="code ">rabbitmq-queues rebalance all</span> whenever the cluster is updated.
When set to true, operator will skip running <span class="code ">rabbitmq-queues rebalance all</span>.
For more information, see <a href="../../rabbitmq-queues.8.html#rebalance">rabbitmq-queues rebalance all</a>.</p>
<p><strong>Default Value:</strong> false</p>
<p><strong>Example:</strong></p>
<pre class="lang-yaml">
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rabbitmqcluster-sample
spec:
  skipPostDeploySteps: true
</pre>

<h3><a name="TerminationGracePeriodSeconds" class="anchor" href="#TerminationGracePeriodSeconds" id="TerminationGracePeriodSeconds">Termination Grace Period Timeout</a></h3>
<p><strong>Description:</strong> TerminationGracePeriodSeconds is the timeout that each rabbitmqcluster pod will have to run the container preStop lifecycle hook to ensure graceful termination.
The lifecycle hook checks quorum status of existing quorum queues and synchronization of mirror queues, before safely terminates pods.
See <a href="../..//rabbitmq-queues.8.html#check_if_node_is_quorum_critical">rabbitmq-queues check_if_node_is_quorum_critical</a> and <a href="../../rabbitmq-queues.8.html#check_if_node_is_mirror_sync_critical">rabbitmq-queues check_if_node_is_mirror_sync_critical</a> for more details.
It defaults to 604800 seconds ( a week long) to ensure that the hook can finish running.
If pods are terminated before the lifecycle hook finishes running, there could be potential data loss.</p>
<p><strong>Default Value:</strong> 604800</p>
<p><strong>Example:</strong></p>
<pre class="lang-yaml">
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: rabbitmqcluster-sample
spec:
  terminationGracePeriodSeconds: 60
</pre>

<h3><a name="override" class="anchor" href="#override" id="override">Override Resource Properties</a></h3>
<p><strong>Description:</strong> Use with caution! Customize resources created by the operator by overriding their properties or providing additional settings. This is an advanced feature that allows you to enable features that are not explicitly supported but can easily render your RabbitMQ Cluster unusable if used incorrectly. You can customize the StatefulSet and the Service used by client applications. The values for <span class="code ">spec.override.statefulSet</span> and <span class="code ">spec.override.service</span> should match <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#statefulset-v1-apps">StatefulSet object</a> and <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#service-v1-core">Service object</a> specification respectively.</p>
<p><strong>Default Value:</strong> N/A</p>
<p><strong>Example:</strong></p>
<pre class="lang-yaml">
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: additional-port
spec:
  replicas: 1
  override:
    service:
      spec:
        ports:
          - name: additional-port # adds an additional port on the service
            protocol: TCP
            port: 12345
    statefulSet:
      spec:
        template:
          spec:
            containers:
              - name: rabbitmq
                ports:
                  - containerPort: 12345 # opens an additional port on the rabbitmq server container
                    name: additional-port
                    protocol: TCP
</pre>

<p>When customizing the environment variables of a container (<span class="code ">env</span> property), you can refer to <span class="code ">MY_POD_NAME</span>, <span class="code ">MY_POD_NAMESPACE</span> and
<span class="code ">K8S_SERVICE_NAME</span> variables to access container metadata. For example:</p>
<pre class="lang-yaml">
- name: MY_VARIABLE
  value: test-$(MY_POD_NAME).$(K8S_SERVICE_NAME).$(MY_POD_NAMESPACE)
</pre>

<h2><a id="update" class="anchor" href="#update">Update a RabbitMQ Instance</a></h2>
<p>It is possible to add, change, or remove properties in a <span class="code ">RabbitmqCluster</span> object for an existing RabbitMQ instance.</p>
<p>If a property is removed, it reverts to its default value, if it has one.
To view the default values, see <a href="#configure">Configure a RabbitMQ Instance</a> above.</p>
<p>The configurations are listed in the table below.</p>
<table class="nice">
    <col width="33%">
    <th>Custom Resource attribute</th>
    <th>Description</th>
    <tr>
      <td>
        <span class="code ">metadata.labels</span>
      </td>
      <td>
        These are labels to add to every child resource, such as StatefulSet and Service.
        Labels starting with <span class="code ">app.kubernetes.io</span> are ignored because these are reserved for internal use.
        Labels are not applied to Pods.
      </td>
    </tr>
    <tr>
      <td>
        <span class="code ">metadata.annotations</span>
      </td>
      <td>
        These are annotations to add to every child resource, such as StatefulSet and Service.<br />
        Annotations containing <span class="code ">kubernetes.io</span> and <span class="code ">k8s.io</span> are ignored because these
        are reserved for Kubernetes core components.
        When <span class="code ">spec.service.annotations</span> is specified, annotations for the service are merged between
        <span class="code ">spec.service.annotations</span> and <span class="code ">metadata.annotations</span>.<br />
        If the same key is specified in both configurations, the value from <span class="code ">spec.service.annotations</span>
        is applied.
      </td>
    </tr>
    <tr>
      <td>
        <span class="code ">spec.image</span>
      </td>
      <td>
      The RabbitMQ image reference.
      </td>
    </tr>
    <tr>
      <td>
        <span class="code ">spec.replicas</span>
      </td>
      <td>
      The number of replicas of RabbitMQ nodes. Even numbers are
      <a href="../../clustering.html#node-count">highly discouraged</a>
      and it is strongly recommended to use odd numbers.
      </td>
    </tr>
    <tr>
      <td>
        <span class="code ">spec.imagePullSecrets</span>
      </td>
      <td>An array of names of <a href="https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/#create-a-secret-by-providing-credentials-on-the-command-line">Kubernetes secrets</a>,
      used to access the registry which contains the RabbitMQ image. This is only required for private registries.
      </td>
    </tr>
    <tr>
      <td>
        <span class="code ">spec.service.type</span>
      </td>
      <td>
      The Kubernetes Service type for the RabbitmqCluster Service. This must be ClusterIP, NodePort, or LoadBalancer.
      </td>
    </tr>
    <tr>
      <td>
        <span class="code ">spec.service.annotations</span>
      </td>
      <td>
      These are annotations on the service. Note that annotations containing <span class="code ">kubernetes.io</span> and <span class="code ">k8s.io</span>
      are <b>not</b> filtered at this level.
      </td>
    </tr>
    <tr>
      <td>
        <span class="code ">spec.persistence.storage</span>
      </td>
      <td>
      The capacity of the persistent volume, expressed as a Kubernetes resource quantity. Set to `0` to deactivate persistence altogether (this may be convenient in CI/CD and test deloyments that should always start fresh).
      </td>
    </tr>
    <tr>
      <td>
        <span class="code ">spec.persistence.storageClassName</span>
      </td>
      <td>
      The name of the Kubernetes StorageClass that will be used to request Persistent Volumes.
      </td>
    </tr>
    <tr>
      <td>
        <span class="code ">spec.resources.requests.cpu</span>
      </td>
      <td>
        The CPU units required by the Kubernetes scheduler for the container running RabbitMQ.
      </td>
    </tr>
    <tr>
      <td>
        <span class="code ">spec.resources.requests.memory</span>
      </td>
      <td>
        The memory units required by the Kubernetes scheduler for the container running RabbitMQ.
      </td>
    </tr>
    <tr>
      <td>
        <span class="code ">spec.resources.limits.cpu</span>
      </td>
      <td>
        The CPU units used to calculate the share of CPU time available to the RabbitMQ container per 100 ms.
      </td>
    </tr>
    <tr>
      <td>
        <span class="code ">spec.resources.limits.memory</span>
      </td>
      <td>
        The memory limit allowed to be used by RabbitMQ container. The container won't be allowed to use more than this limit.
      </td>
    </tr>
    <tr>
      <td>
        <span class="code ">spec.affinity</span>
      </td>
      <td>
        The Pod affinity and anti-affinity rules.
      </td>
    </tr>
    <tr>
      <td>
        <span class="code ">spec.tolerations</span>
      </td>
      <td>
        Pod tolerations that will be applied to RabbitMQ Pods.
      </td>
    </tr>
    <tr>
      <td>
        <span class="code ">spec.tls.secretName</span>
      </td>
      <td>
        The Secret name used to configure RabbitMQ TLS. The Secret must exist and contain keys `tls.key` and `tls.crt`.
      </td>
    </tr>
    <tr>
      <td>
        <span class="code ">spec.tls.caSecretName</span>
      </td>
      <td>
        The Secret name used to configure RabbitMQ mTLS (used to verify clients' certificates). The Secret must exist and contain key `ca.crt`.
      </td>
    </tr>
    <tr>
      <td>
        <span class="code ">spec.tls.disableNonTLSListeners</span>
      </td>
      <td>
        When set to `true`, only TLS connections are allowed (non-TLS listeners are disabled).
      </td>
    </tr>
    <tr>
      <td>
        <span class="code ">spec.rabbitmq.additionalPlugins</span>
      </td>
      <td>
        List of plugins to enabled in RabbitMQ. By default, RabbitMQ Cluster Kubernetes Operator enables Prometheus, K8s Peer
    Discovery and Management plugins.
      </td>
    </tr>
    <tr>
      <td>
        <span class="code ">spec.rabbitmq.additionalConfig</span>
      </td>
      <td>
        Additional configuration to append to the Cluster Generated configuration. Check <a href="#additional-config">Additional Config</a>
    section for the list of always generated configuration.
      </td>
    </tr>
    <tr>
      <td>
        <span class="code ">spec.rabbitmq.advancedConfig</span>
      </td>
      <td>
        RabbitMQ <span class="code ">advanced.config</span>. See <a href="#advanced-config">RabbitMQ Advanced Configuration</a> for an example.
      </td>
    </tr>
    <tr>
      <td>
        <span class="code ">spec.override</span>
      </td>
      <td>
        Arbitrary overrides to the resources created by RabbitMQ Cluster Kubernetes Operator. This feature should be
        used with <strong>great care</strong> as overriding essential properties can render a RabbitMQ cluster unusable
        to applications or unreachable to the Operator.
        See the <a href="#override">Override section</a> to learn more.
      </td>
    </tr>
    </col>
</table>

<p>For more information about CPU units, the Kubernetes scheduler, and CPU time availability, see the
<a href="https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container">Kubernetes guide on compute resources</a>.</p>
<p>For more information about Pod affinity and anti-affinity rules, see the
<a href="https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity">Kubernetes guide on affinity rules</a>.</p>
<p>To update a RabbitMQ instance:</p>
<ol>
<li>Open <span class="code ">definition.yaml</span>.</li>
<li>Add or modify any of the properties listed in the table above.</li>
<li>Save your changes to <span class="code ">definition.yaml</span>.</li>
<li>Apply the definition by running: <span class="code ">kubectl apply -f definition.yaml</span></li>
</ol>
<h2><a id="set-pdb" class="anchor" href="#set-pdb">(Optional) Set a Pod Disruption Budget</a></h2>
<p>A Pod Disruption Budget (PDB) limits the number of Pod replicas that are down simultaneously because of
voluntary disruptions.</p>
<p>For example, a PDB can help:</p>
<ul>
<li>Maintain the availability of quorum-based distributed workloads during maintenance events, such
as Kubernetes API upgrades or kernel upgrades.</li>
<li>Reduce downtime for RabbitMQ configurations that normally sacrifice availability in favor of data
consistency, such as pause-minority mode for partition tolerance.</li>
</ul>
<h3><a id="create-pdb" class="anchor" href="#create-pdb">Create a <span class="code ">PodDisruptionBudget</span> Object</a></h3>
<p>To create and set a <span class="code ">PodDisruptionBudget</span> object, first create a file called <span class="code ">rabbitmq-pdb.yaml</span> that includes:</p>
<pre class="lang-yaml">
    apiVersion: policy/v1beta1
    kind: PodDisruptionBudget
    metadata:
      name: pdb-rabbitmq
    spec:
      maxUnavailable: 1
      selector:
        matchLabels:
          app.kubernetes.io/name: YOUR-RABBITMQ-CUSTOM-RESOURCE-NAME
</pre>

<p>Then run</p>
<pre class="lang-bash">
kubectl apply -f rabbitmq-pdb.yaml
</pre>

<p>For more information about concepts mentioned above, see:</p>
<table class="nice">
  <col width="50%" />
  <col width="50%">
    <th>Concept</th>
    <th>More information in…</th>
    <tr>
        <td>PDBs</td>
        <td>The <a href="https://kubernetes.io/docs/tasks/run-application/configure-pdb/">Kubernetes documentation</a></td>
    </tr>
    <tr>
        <td>Voluntary and involuntary disruptions</td>
        <td>The <a href="https://kubernetes.io/docs/concepts/workloads/pods/disruptions/#voluntary-and-involuntary-disruptions">Kubernetes documentation</a></td>
    </tr>
    <tr>
        <td>pause-minority mode</td>
        <td>The <a href="../../partitions.html#automatic-handling">RabbitMQ documentation</a></td>
    </tr>
  </col>
</table>

<h2><a id="tls" class="anchor" href="#tls">(Optional) Configure TLS</a></h2>
<p>Transport Layer Security (TLS) is a protocol for encrypting network traffic. <a href="../../ssl.html">RabbitMQ supports TLS</a>, and the cluster operator simplifies the process of configuring a RabbitMQ cluster with <a href="#one-way-tls">TLS</a> or
<a href="#mutual-tls">mutual TLS (mTLS)</a> encrypted traffic between clients and the cluster, as well
as supporting <a href="https://github.com/rabbitmq/cluster-operator/tree/main/docs/examples/mtls-inter-node">encrypting RabbitMQ inter-node traffic with mTLS</a>.
A <a href="../../ssl.html#certificates-and-keys">basic overview of TLS</a> is helpful for understanding this guide.</p>
<h3><a id="one-way-tls" class="anchor" href="#one-way-tls">TLS encrypting traffic between clients and RabbitMQ</a></h3>
<p>In order to encrypt traffic between clients and the RabbitMQ cluster, the RabbitMQ cluster must be configured with a server certificate and key pair signed by a Certificate Authority (CA) trusted by the clients. This allows clients to verify that the server is trusted, and traffic sent between the client and server are encrypted using the server's keys.</p>
<p>The certificate's Subject Alternative Name (SAN) must contain at least the following attributes:
* <span class="code ">*.&lt;RabbitMQ cluster name&gt;-nodes.&lt;namespace&gt;.svc.&lt;K8s cluster domain name&gt;</span>
* <span class="code ">&lt;RabbitMQ cluster name&gt;.&lt;namespace&gt;.svc.&lt;K8s cluster domain name&gt;</span></p>
<p>If wildcards are not permitted, the certificate must provide a SAN attribute for each RabbitMQ node in the RabbitMQ cluster.
For example, if you deploy a 3-node RabbitMQ cluster named <span class="code ">myrabbit</span> in namespace <span class="code ">mynamespace</span> with the default Kubernetes cluster domain <span class="code ">cluster.local</span>, the SAN must include at least the following attributes:
* <span class="code ">myrabbit-server-0.myrabbit-nodes.mynamespace.svc.cluster.local</span>
* <span class="code ">myrabbit-server-1.myrabbit-nodes.mynamespace.svc.cluster.local</span>
* <span class="code ">myrabbit-server-2.myrabbit-nodes.mynamespace.svc.cluster.local</span>
* <span class="code ">myrabbit.mynamespace.svc.cluster.local</span></p>
<p>Note that the last SAN attribute is the client service DNS name.
Depending on the service type used (<span class="code ">spec.service.type</span>), further SAN attributes may be required.
For example, if using service type <span class="code ">NodePort</span>, the SAN must include the external IP address of each Kubernetes node.</p>
<p>To enable TLS, create a Kubernetes secret containing the PEM-encoded server certificate <span class="code ">server.pem</span> and private key <span class="code ">server-key.pem</span></p>
<pre class="lang-bash">
kubectl create secret tls tls-secret --cert=server.pem --key=server-key.pem
</pre>

<p>or use a tool such as <a href="https://cert-manager.io/">Cert Manager</a> to generate a TLS secret.</p>
<p>Once this secret exists, a RabbitMQ cluster can be deployed following the <a href="https://github.com/rabbitmq/cluster-operator/tree/main/docs/examples/tls">TLS example</a>.</p>
<pre class="lang-yaml">
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: additional-port
spec:
  replicas: 1
  tls:
    secretName: tls-secret
</pre>

<h3><a id="mutual-tls" class="anchor" href="#mutual-tls">Mutual TLS encryption between clients and RabbitMQ</a></h3>
<p>Mutual TLS (mTLS) enhances TLS by requiring that the server verify the identity of the client, in addition to the client verifying the server, which already occurs in TLS encryption. In order for this mutual verification to occur, both the client and server must be configured with certificate and key pairs, with the client pair signed by a CA trusted by the server and the server pair signed by a CA trusted by the client. The mutual verification process is shown in the following diagram:</p>
<p><img src="../../img/mTLS.png" alt="Mutual verification process" /></p>
<p>In addition to the <a href="#one-way-tls">configuration required to support TLS</a>, configuring mutual TLS requires the RabbitMQ cluster to be configured with the CA certificate
used to sign the client certificate and key pair, <span class="code ">ca.pem</span>. Create a Kubernetes secret with key <span class="code ">ca.crt</span> containing this secret</p>
<pre class="lang-bash">
kubectl create secret generic ca-secret --from-file=ca.crt=ca.pem
</pre>

<p>or create this secret using a tool such as <a href="https://cert-manager.io/">Cert Manager</a>.</p>
<p>Once this secret and the <span class="code ">tls-secret</span> exist, a RabbitMQ cluster can be deployed following the <a href="https://github.com/rabbitmq/cluster-operator/tree/main/docs/examples/mtls">mTLS example</a>.</p>
<pre class="lang-yaml">
apiVersion: rabbitmq.com/v1beta1
kind: RabbitmqCluster
metadata:
  name: mtls
spec:
  replicas: 1
  tls:
    secretName: tls-secret
    caSecretName: ca-secret
</pre>

<p>In order to enforce client verification, RabbitMQ must be configured to reject clients that do not present certificates. This can be done by enabling <a href="../../ssl.html#peer-verification">TLS peer verification</a> using
the <span class="code ">ssl_options.fail_if_no_peer_cert</span> option in the additional config:</p>
<pre class="lang-yaml">
spec:
  rabbitmq:
    additionalConfig: |
      ssl_options.fail_if_no_peer_cert = true
</pre>

<h2><a id="find" class="anchor" href="#find">Find Your RabbitmqCluster Service Name and Admin Credentials</a></h2>
<p>If an app is deployed in the same Kubernetes cluster as RabbitMQ, the RabbitmqCluster Service name
and admin credentials can be used to connect such app to RabbitMQ.
The steps required to make that connection can vary greatly by deployment and are beyond the scope of this
documentation.</p>
<p>Follow the procedures below to find your <span class="code ">RabbitmqCluster</span> Service name and admin credentials.</p>
<h3><a id="name" class="anchor" href="#name">Find Your RabbitmqCluster Service Name</a></h3>
<p>The Service used to access RabbitMQ Pods is displayed in the Custom Resource Status field as <span class="code ">status.serviceReference</span>.
This field shows the Service name and namespace. The following command shows how to fetch this information:</p>
<pre class="lang-bash">
kubectl get rabbitmqcluster INSTANCE \
-ojsonpath='Name: {.status.admin.serviceReference.name} -- Namespace: {.status.admin.serviceReference.namespace}'
</pre>

<p>Where <span class="code ">INSTANCE</span> is the name of <span class="code ">RabbitmqCluster</span> resource.</p>
<p>For more information on how to connect using Services, check
<a href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#services">Kubernetes documentation</a>
regarding Service DNS.</p>
<h3><a id="creds" class="anchor" href="#creds">Retrieve Your RabbitMQ Admin Credentials</a></h3>
<p>Admin credentials for a RabbitmqCluster are stored in a Kubernetes secret called <span class="code ">INSTANCE-default-user</span>,
where <span class="code ">INSTANCE</span> is the name of the <span class="code ">RabbitmqCluster</span> object.
Kubernetes encodes secrets using base64.</p>
<p>The name and namespace of the secret is also present in the custom resource status. To retrieve the Secret name,
run <span class="code ">kubectl get rabbitmqcluster INSTANCE -ojsonpath='{.status.defaultUser.secretReference.name}'</span></p>
<p>To retrieve credentials and display them in plaintext, first display the username by running:</p>
<pre class="lang-bash">
kubectl -n NAMESPACE get secret INSTANCE-default-user -o jsonpath="{.data.username}" | base64 --decode
</pre>

<p>Where:</p>
<ul>
  <li><span class="code ">INSTANCE</span> is the name of your <span class="code ">RabbitmqCluster</span></li>
  <li><span class="code ">NAMESPACE</span> is the Kubernetes namespace that contains <span class="code ">RabbitmqCluster</span></li>
</ul>

<p>Next, display the password by running:</p>
<pre class="lang-bash">
kubectl -n NAMESPACE get secret INSTANCE-default-user -o jsonpath="{.data.password}" | base64 --decode
</pre>

<h2><a id="vault" class="anchor" href="#vault">(Optional) Use HashiCorp Vault</a></h2>
<p>The RabbitMQ Cluster Operator supports storing RabbitMQ admin credentials and RabbitMQ server certificates
in <a href="https://www.vaultproject.io/">HashiCorp Vault</a>.</p>
<p>Note that the Operator works with Vault <a href="https://www.vaultproject.io/docs/secrets/kv/kv-v2">KV secrets engine version 2</a> only. </p>
<h3><a id="vault-default-user" class="anchor" href="#vault-default-user">Read RabbitMQ Admin Credentials from Vault</a></h3>
<p>Instead of having the Operator create RabbitMQ admin credentials putting them into a Kubernetes Secret object
as described in <a href="#creds">Retrieve Your RabbitMQ Admin Credentials</a>, you can configure a RabbitmqCluster to
read RabbitMQ admin credentials from Vault.
To do so, follow the <a href="https://github.com/rabbitmq/cluster-operator/tree/main/docs/examples/vault-default-user">vault-default-user example</a> and configure the Vault secret backend:</p>
<pre class="lang-yaml">
spec:
  secretBackend:
    vault:
      role: rabbitmq
      # Optionally, set Vault annotations as listed in
      # https://www.vaultproject.io/docs/platform/k8s/injector/annotations
      annotations:
        vault.hashicorp.com/template-static-secret-render-interval: "15s"
      defaultUserPath: secret/data/rabbitmq/config
</pre>

<p>The credentials must have been written to Vault before the RabbitmqCluster is created.
As described in the example, RabbitMQ admin password rotation is supported without the need to restart the RabbitMQ server.</p>
<h3><a id="vault-tls" class="anchor" href="#vault-tls">Issue RabbitMQ Server Certificates from Vault</a></h3>
<p>To configure TLS, instead of providing a Kubernetes Secret object containing RabbitMQ server private key, certificate, and certificate authority
as described in <a href="#tls-conf">TLS Configuration</a>, you can configure a RabbitmqCluster to request new short-lived server certificates from
<a href="https://www.vaultproject.io/docs/secrets/pki">Vault PKI Secrets Engine</a> upon every RabbitMQ Pod (re)start.
To do so, follow the <a href="https://github.com/rabbitmq/cluster-operator/tree/main/docs/examples/vault-tls">vault-tls example</a> and configure the vault secret backend:</p>
<pre class="lang-yaml">
spec:
  secretBackend:
    vault:
      role: rabbitmq
      tls:
        pkiIssuerPath: pki/issue/cert-issuer
</pre>

<p>The RabbitMQ server private key will never be stored in Vault.</p>
<h2><a id="verify-instance" class="anchor" href="#verify-instance">Verify the Instance is Running</a></h2>
<p>Deploy the RabbitMQ throughput testing tool PerfTest to quickly verify that your instance is running correctly.
For more information, see <a href="https://github.com/rabbitmq/rabbitmq-perf-test">PerfTest</a> in GitHub.</p>
<p>
  <strong>Note:</strong> if the below commands are executed from outside the namespace where <span class="code ">RabbitmqCluster</span>
  object was created, add <span class="code ">-n NAMESPACE</span> to the kubectl commands below.
</p>

<p>To install and run PerfTest, run these commands:</p>
<pre class="lang-bash">
instance=INSTANCE-NAME
username=$(kubectl get secret ${instance}-default-user -o jsonpath="{.data.username}" | base64 --decode)
password=$(kubectl get secret ${instance}-default-user -o jsonpath="{.data.password}" | base64 --decode)
service=${instance}
kubectl run perf-test --image=pivotalrabbitmq/perf-test -- --uri "amqp://${username}:${password}@${service}"
</pre>

<p>To verify that PerfTest is sending and receiving messages by running:</p>
<pre class="lang-bash">
kubectl logs -f perf-test
</pre>

<p>A log appears as in this example:</p>
<pre class="lang-bash">
kubectl logs -f perf-test
# id: test-104555-858, starting consumer #0
# id: test-104555-858, starting consumer #0, channel #0
# id: test-104555-858, starting producer #0
# id: test-104555-858, starting producer #0, channel #0
# id: test-104555-858, time: 1.000s, sent: 19057 msg/s, received: 11768 msg/s, min/median/75th/95th/99th consumer latency: 4042/140608/190841/251618/258979 micro-s
# id: test-104555-858, time: 2.000s, sent: 24020 msg/s, received: 16283 msg/s, min/median/75th/95th/99th consumer latency: 222998/507432/642110/754038/776600 micro-s
</pre>

<p>To delete a PerfTest instance, use</p>
<pre class="lang-bash">
kubectl delete pod perf-test
</pre>

<h2><a id="use" class="anchor" href="#use">Use the RabbitMQ Service in Your App</a></h2>
<p>For information about how to start using your apps, see
<a href="../../getstarted.html">RabbitMQ tutorials</a>
and guides on <a href="../../consumers.html">Connections</a>, <a href="../../publishers.html">Publishers</a>, and <a href="../../consumers.html">Consumers</a>.</p>
<h2><a id="monitoring" class="anchor" href="#monitoring">Monitor RabbitMQ Clusters</a></h2>
<p>For production systems, it is critically important to enable RabbitMQ cluster <a href="../../monitoring.html">monitoring</a>.</p>
<p>See <a href="./operator-monitoring.html">Monitoring RabbitMQ in Kubernetes</a> to learn about
the recommended monitoring options for Kubernetes-deployed clusters.</p>
<h2><a id="network-policies" class="anchor" href="#network-policies">Restrict traffic using Network Policies</a></h2>
<p><a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/">Network Policies</a>, akin to firewalls, allow you to restrict traffic to/from Pods in your RabbitmqCluster at the IP address or port level.
This may be worth doing on a production cluster, for example, to ensure only Pods in the RabbitmqCluster can access the <a href="../../clustering.html#ports">inter-node communication ports</a> (epmd and clustering), or to restrict messaging traffic to only be permitted from known
trusted client Pods.</p>
<p>The cluster-operator repo has <a href="https://github.com/rabbitmq/cluster-operator/tree/main/docs/examples/network-policies">a documented example</a> with several sample NetworkPolicies that you can use as guides for
defining your own secure network topology.</p>
<h2><a id="delete" class="anchor" href="#delete">Delete a RabbitMQ Instance</a></h2>
<p>To delete a RabbitMQ service instance, run</p>
<pre class="lang-bash">
kubectl delete rabbitmqcluster INSTANCE
</pre>

<p>where <span class="code ">INSTANCE</span> is the name of your RabbitmqCluster,
or use</p>
<pre class="lang-bash">
kubectl delete -f INSTANCE.yaml
</pre>

<h2><a id="pause" class="anchor" href="#pause">Pause Reconciliation for a RabbitMQCluster</a></h2>
<p>It is possible to pause reconciliation for a RabbitMQ instance: this will prevent the cluster operator from watching and updating the instance. To do so, set a special label "rabbitmq.com/pauseReconciliation=true" on your RabbitmqCluster.</p>
<p>This feature can be used if you wish to upgrade to a new version of the cluster operator but do not wish for the operator to start updating some of your RabbitmqCluster. Please be aware that pausing reconciliation means that the operator will not watch this RabbitmqCluster until the special label is removed. Any updates to the paused RabbitmqCluster will be ignored by the operator and if you accidentally delete a child resource of the RabbitmqCluster (e.g. the Stateful Set or Service object), deleted object won't be recreated automatically. We do not recommend using this feature unless absolutely necessary.</p>
<p>To pause reconciliation, set the label by running:</p>
<pre class="lang-bash">
kubectl label rabbitmqclusters INSTANCE-NAME rabbitmq.com/pauseReconciliation=true
</pre>

<p>where <span class="code ">INSTANCE</span> is the name of your RabbitmqCluster.</p>
<p>To resume reconciliation, remove the label by running:</p>
<pre class="lang-bash">
kubectl label rabbitmqclusters INSTANCE-NAME rabbitmq.com/pauseReconciliation-
</pre>

<h2><a id="operator-log" class="anchor" href="#operator-log">Configure Log Level for the Operator</a></h2>
<p>The Operator logs reconciliation results and errors. Operator logs can be inspected by <span class="code ">kubectl -n rabbitmq-system logs -l app.kubernetes.io/name=rabbitmq-cluster-operator</span>.
It uses zap logger which can be configured via passing command line flags in the Operator deployment manifest.</p>
<p>For example, to configure the log level to 'debug':</p>
<pre class="lang-yaml">
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rabbitmq-cluster-operator
  namespace: rabbitmq-system
spec:
  template:
    spec:
      containers:
      - args:
        - --zap-log-level=debug
        command:
        - /manager
</pre>

<p>Other available command line flags for the zap logger can be found documented in <a href="https://github.com/kubernetes-sigs/controller-runtime/blob/v0.10.2/pkg/log/zap/zap.go#L240-L246">controller runtime</a>.</p><div id="help-and-feedback"><h2>Getting Help and Providing Feedback</h2><p>
                    If you have questions about the contents of this guide or
                    any other topic related to RabbitMQ, don't hesitate to ask them
                    on the <a href="https://groups.google.com/forum/#!forum/rabbitmq-users">RabbitMQ mailing list</a>.
                  </p></div><div id="contribute"><h2>Help Us Improve the Docs &lt;3</h2><p>
                    If you'd like to contribute an improvement to the site,
                    its source is <a href="https://github.com/rabbitmq/rabbitmq-website">available on GitHub</a>.
                    Simply fork the repository and submit a pull request. Thank you!
                  </p></div></div><div id="right-nav"></div></div><div class="clear"></div><div class="pageFooter"><div class="container"></div><div class="container"><div class="rabbit-logo"><a href="/"><img src="/img/logo-rabbitmq-white.svg" alt="RabbitMQ" /></a></div><ul class="footerNav"><li><a href="/#features">Features</a></li><li><a href="/#getstarted">Get Started</a></li><li><a href="/#support">Support</a></li><li><a href="/#community">Community</a></li><li><a href="/documentation.html">Docs</a></li></ul><p id="copyright">
          Copyright © 2007-2023 <a href="https://tanzu.vmware.com/">VMware</a>, Inc. or its affiliates. All rights reserved.
          <a href="https://www.vmware.com/help/legal.html">Terms of Use</a> •
          <a href="https://www.vmware.com/help/privacy.html">Privacy</a> •
          <a href="/trademark-guidelines.html">Trademark Guidelines</a> •
          <a href="https://www.vmware.com/help/privacy/california-privacy-rights.html">Your California Privacy Rights</a> •
          <a class="ot-sdk-show-settings">Cookie Settings</a><br /><a id="teconsent"></a></p></div></div></div><script type="text/javascript" src="/js/highlight.pack.js"></script><script type="text/javascript">
        // code highlighting
        window.addEventListener("load", function() {
          const selectors = "pre.lang-apacheconf, \
                             pre.lang-bash, \
                             pre.lang-csharp, \
                             pre.lang-clojure, \
                             pre.lang-elixir, \
                             pre.lang-erlang, \
                             pre.lang-go, \
                             pre.lang-groovy, \
                             pre.lang-haskell, \
                             pre.lang-ini, \
                             pre.lang-java, \
                             pre.lang-javascript, \
                             pre.lang-json, \
                             pre.lang-makefile, \
                             pre.lang-nginxconf, \
                             pre.lang-objectivec, \
                             pre.lang-php, \
                             pre.lang-plaintext, \
                             pre.lang-powershell, \
                             pre.lang-python, \
                             pre.lang-ruby, \
                             pre.lang-swift, \
                             pre.lang-yaml, \
                             pre.lang-xml";
          document.querySelectorAll(selectors).forEach(function(el) {
            hljs.highlightBlock(el);
          });
        });
      </script></body>
</html>
